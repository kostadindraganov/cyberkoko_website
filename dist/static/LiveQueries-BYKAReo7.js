import{b as x,r as b,bC as k,L as D,u as V,j as C,bD as U,cI as J,cJ as T,cK as K,bK as H,cL as B,cM as W,cN as Y}from"./sanity-CNmy13iJ.js";import{w as z,g as F,a as G,b as P,r as X,p as Z,t as ee,c as te,d as re,e as se}from"./PresentationToolGrantsCheck-DuWZbEGv.js";import{i as L}from"./DisplayedDocumentBroadcaster-BjOgLLAP.js";function ne(t){if(Array.isArray(t)){for(const e of t)if(e!=="published"&&e!=="drafts"&&!(typeof e=="string"&&e.startsWith("r")&&e!=="raw"))throw new TypeError("Invalid API perspective value, expected `published`, `drafts` or a valid release identifier string");return}switch(t){case"previewDrafts":case"drafts":case"published":case"raw":return;default:throw new TypeError("Invalid API perspective string, expected `published`, `previewDrafts` or `raw`")}}function ae(t){if(ne(t),Array.isArray(t))return t.includes("published")?t:[...t,"published"];switch(t){case"previewDrafts":case"drafts":return["drafts","published"];case"published":default:return["published"]}}function ie(t,e){const s=ae(e);function i(r){for(const a of s){let n=null;if(a.startsWith("r")&&(n=t({...r,_id:F(r._id,a)})),a==="drafts"&&(n=t({...r,_id:G(r._id)})),a==="published"&&(n=t({...r,_id:P(r._id)})),n)return{...n,_id:P(n._id),_originalId:n._id}}return null}return function(r){return i(r)}}function ue(t,e,s,i,r){var f,h;if(!e)return t;const a=ie(s,r),n=((h=(f=e.documents)==null?void 0:f.map)==null?void 0:h.call(f,a))||[];return z(JSON.parse(JSON.stringify(t)),(l,c)=>{const d=X(c,e);if(!d)return l;const{mapping:u,pathSuffix:I}=d;if(u.type!=="value"||u.source.type!=="documentValue")return l;const m=e.documents[u.source.document],E=e.paths[u.source.path];if(m){const g=Z(E+I),w=ee(g),S=n[u.source.document];if(!S)return l;const A=S?te(S,w,l):l;return l===A?l:i(A,{cachedDocument:S,previousValue:l,sourceDocument:m,sourcePath:g})}return l})}function oe(t,e){switch(e.type){case"message":return{...t,messages:[...t.messages,e]};case"reconnect":case"restart":return{...t,messages:[],resets:t.resets+1};case"welcome":return t;default:throw Error(`Unknown event: ${e.type}`,{cause:e})}}const ce={messages:[],resets:0};function le(t){const e=x.c(3),[s,i]=b.useReducer(oe,ce),[r,a]=b.useState(null);if(r!==null)throw r;let n,f;return e[0]!==t.live?(n=()=>{const h=t.live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:i,error:l=>a(l instanceof Error?l:new Error("Unexpected error in useLiveEvents",{cause:l}))});return()=>h.unsubscribe()},f=[t.live],e[0]=t.live,e[1]=n,e[2]=f):(n=e[1],f=e[2]),b.useEffect(n,f),b.useDeferredValue(s)}const pe=(t,{previousValue:e})=>{if(typeof e=="string"){if(typeof t=="number")return`${t}`;if(Array.isArray(t)){if(t.length===0)return"";if(t.some(s=>typeof s=="object"&&W(s)))return Y(t)}}return t};function fe(t,e,s){return`${t}:${e}:${JSON.stringify(s)}`}function de(t){if(t.queries.size<1)return t;const e=Date.now();if(!Array.from(t.heartbeats.values()).some(r=>r.heartbeat!==!1&&e>r.receivedAt+r.heartbeat))return t;const s=new Map,i=new Map;for(const[r,a]of t.heartbeats.entries())a.heartbeat!==!1&&e>a.receivedAt+a.heartbeat||(s.set(r,a),i.set(r,t.queries.get(r)));return{...t,queries:i,heartbeats:s}}function he(t,{payload:e}){const s=fe(e.perspective,e.query,e.params),i={query:e.query,params:e.params,perspective:e.perspective},r=new Map(t.heartbeats);r.set(s,{receivedAt:Date.now(),heartbeat:e.heartbeat});let a=t.queries;return(!t.queries.has(s)||!L(t.queries.get(s),i))&&(a=new Map(t.queries),a.set(s,i)),{heartbeats:r,queries:a}}function ye(t,e){switch(e.type){case"query-listen":return he(t,e);case"gc":return de(t);default:throw Error(`Unknown action: ${e.type}`,{cause:e})}}const be={queries:new Map,heartbeats:new Map};function me(){const t=x.c(4),[e,s]=b.useReducer(ye,be);let i,r;t[0]===Symbol.for("react.memo_cache_sentinel")?(i=()=>{const f=setInterval(()=>s({type:"gc"}),J);return()=>clearInterval(f)},r=[],t[0]=i,t[1]=r):(i=t[0],r=t[1]),b.useEffect(i,r);const a=b.useDeferredValue(e.queries);let n;return t[2]!==a?(n=[a,s],t[2]=a,t[3]=n):n=t[3],n}function _e(t){const e=x.c(31),{controller:s,perspective:i,onLoadersConnection:r,onDocumentsOnPage:a}=t,[n,f]=b.useState(),[h,l]=me(),c=k(),d=D();let u,I;e[0]!==s||e[1]!==d||e[2]!==l||e[3]!==a||e[4]!==r||e[5]!==c?(u=()=>{if(s){const M=s.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},re().provide({actors:se()}));return f(M),M.onStatus(r),M.on("loader/documents",v=>{v.projectId===c&&v.dataset===d&&a("loaders",v.perspective,v.documents)}),M.on("loader/query-listen",v=>{if(v.projectId===c&&v.dataset===d){if(typeof v.heartbeat=="number"&&v.heartbeat<T)throw new Error(`Loader query listen heartbeat interval must be at least ${T}ms`);l({type:"query-listen",payload:{perspective:v.perspective,query:v.query,params:v.params,heartbeat:v.heartbeat??!1}})}}),M.start()}return ge},I=[s,d,l,a,r,c],e[0]=s,e[1]=d,e[2]=l,e[3]=a,e[4]=r,e[5]=c,e[6]=u,e[7]=I):(u=e[6],I=e[7]),b.useEffect(u,I);let m;e[8]!==i?(m=B(i)?K:{apiVersion:H},e[8]=i,e[9]=m):m=e[9];const E=V(m);let g,w;e[10]!==E?(w=E.withConfig({resultSourceMap:"withKeyArraySelector"}),e[10]=E,e[11]=w):w=e[11],g=w;const S=g;let A,_;e[12]!==i||e[13]!==n||e[14]!==d||e[15]!==c?(A=()=>{n&&n.post("loader/perspective",{projectId:c,dataset:d,perspective:i})},_=[n,i,c,d],e[12]=i,e[13]=n,e[14]=d,e[15]=c,e[16]=A,e[17]=_):(A=e[16],_=e[17]),b.useEffect(A,_);const R=b.useDeferredValue(t.liveDocument),q=le(S);let y;e[18]!==h?(y=h.entries(),e[18]=h,e[19]=y):y=e[19];let o;e[20]!==y?(o=[...y],e[20]=y,e[21]=o):o=e[21];let p;return e[22]!==S||e[23]!==n||e[24]!==d||e[25]!==R||e[26]!==q.messages||e[27]!==q.resets||e[28]!==c||e[29]!==o?(p=C.jsx(C.Fragment,{children:o.map(M=>{const[v,Q]=M,{query:j,params:N,perspective:O}=Q;return C.jsx($,{projectId:c,dataset:d,perspective:O,query:j,params:N,comlink:n,client:S,liveDocument:R,liveEventsMessages:q.messages},`${q.resets}:${v}`)})}),e[22]=S,e[23]=n,e[24]=d,e[25]=R,e[26]=q.messages,e[27]=q.resets,e[28]=c,e[29]=o,e[30]=p):p=e[30],p}function ge(){}function ve(t){const e=x.c(13),{projectId:s,dataset:i,perspective:r,query:a,client:n,liveDocument:f,params:h,comlink:l,liveEventsMessages:c}=t,{result:d,resultSourceMap:u,syncTags:I}=Ee({client:n,liveDocument:f,params:h,perspective:r,query:a,liveEventsMessages:c})||{};let m;e[0]!==i||e[1]!==s?(m=(S,A,_,R,q,y,o)=>{S==null||S.post("loader/query-change",{projectId:s,dataset:i,perspective:A,query:_,params:R,result:q,resultSourceMap:y,tags:o})},e[0]=i,e[1]=s,e[2]=m):m=e[2];const E=U(m);let g,w;return e[3]!==l||e[4]!==E||e[5]!==h||e[6]!==r||e[7]!==a||e[8]!==d||e[9]!==u||e[10]!==I?(g=()=>{u&&E(l,r,a,h,d,u,I)},w=[l,E,h,r,a,d,u,I],e[3]=l,e[4]=E,e[5]=h,e[6]=r,e[7]=a,e[8]=d,e[9]=u,e[10]=I,e[11]=g,e[12]=w):(g=e[11],w=e[12]),b.useEffect(g,w),null}const $=b.memo(ve);$.displayName="Memo(QuerySubscription)";function Ee(t){const e=x.c(30),{liveDocument:s,client:i,query:r,params:a,perspective:n,liveEventsMessages:f}=t,[h,l]=b.useState(null),[c,d]=b.useState(null),[u,I]=b.useState(void 0);let m;e[0]!==f?(m=()=>new Set(f.map(we)),e[0]=f,e[1]=m):m=e[1];const[E]=b.useState(m);let g;if(e[2]!==f||e[3]!==E||e[4]!==u){let y;e[6]!==E?(y=M=>!E.has(M.id),e[6]=E,e[7]=y):y=e[7];const o=f.filter(y);let p;e[8]!==u?(p=M=>M.tags.some(v=>u==null?void 0:u.includes(v)),e[8]=u,e[9]=p):p=e[9],g=o.findLast(p),e[2]=f,e[3]=E,e[4]=u,e[5]=g}else g=e[5];const w=g==null?void 0:g.id,[S,A]=b.useState(null);if(S)throw S;let _,R;e[10]!==i||e[11]!==w||e[12]!==a||e[13]!==n||e[14]!==r?(_=()=>{const y=new AbortController;return i.fetch(r,a,{lastLiveEventId:w,tag:"presentation-loader",signal:y.signal,perspective:n,filterResponse:!1,returnQuery:!1}).then(o=>{b.startTransition(()=>{l(p=>L(p,o.result)?p:o.result),d(p=>L(p,o.resultSourceMap)?p:o.resultSourceMap),I(p=>L(p,o.syncTags)?p:o.syncTags)})}).catch(o=>{(typeof o!="object"||(o==null?void 0:o.name)!=="AbortError")&&A(o)}),()=>{y.abort()}},R=[i,w,a,n,r],e[10]=i,e[11]=w,e[12]=a,e[13]=n,e[14]=r,e[15]=_,e[16]=R):(_=e[15],R=e[16]),b.useEffect(_,R);let q;e:{if(s&&c){let o;e[17]!==s||e[18]!==n||e[19]!==h||e[20]!==c?(o=Se(s,h,n,c),e[17]=s,e[18]=n,e[19]=h,e[20]=c,e[21]=o):o=e[21];let p;e[22]!==c||e[23]!==u||e[24]!==o?(p={result:o,resultSourceMap:c,syncTags:u},e[22]=c,e[23]=u,e[24]=o,e[25]=p):p=e[25],q=p;break e}let y;e[26]!==h||e[27]!==c||e[28]!==u?(y={result:h,resultSourceMap:c,syncTags:u},e[26]=h,e[27]=c,e[28]=u,e[29]=y):y=e[29],q=y}return q}function we(t){return t.id}function Se(t,e,s,i){if(s==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return ue(e,i,r=>!r._projectId&&(t!=null&&t._id)&&P(t._id)===P(r._id)?typeof t._id=="string"&&typeof r._type=="string"?t:{...t,_id:t._id||r._id,_type:t._type||r._type}:null,pe,s)}export{_e as default,Se as turboChargeResultIfSourceMap};
